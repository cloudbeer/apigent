{% extends "layout.html" %}

{% block title %}æµå¼èŠå¤©åŠ©æ‰‹{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 80%;
        word-wrap: break-word;
    }

    .user-message {
        background-color: #e3f2fd;
        margin-left: auto;
    }

    .assistant-message {
        background-color: white;
        margin-right: auto;
        border: 1px solid #e5e7eb;
    }

    .streaming-message {
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        position: relative;
    }

    .streaming-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #3b82f6;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
        margin-left: 4px;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }

    .input-container {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        resize: none;
        font-family: inherit;
    }

    .send-button {
        padding: 0.75rem 1.5rem;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        white-space: nowrap;
    }

    .send-button:hover:not(:disabled) {
        background-color: #2563eb;
    }

    .send-button:disabled {
        background-color: #93c5fd;
        cursor: not-allowed;
    }

    .session-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .session-id {
        font-family: monospace;
        color: #6b7280;
        font-size: 0.875rem;
    }

    .new-session-btn {
        padding: 0.5rem 1rem;
        background-color: #f3f4f6;
        color: #4b5563;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .new-session-btn:hover {
        background-color: #e5e7eb;
    }

    .tools-info {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #92400e;
    }

    .tools-info-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .tool-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background-color: #3b82f6;
        color: white;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .function-info {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background-color: #f3f4f6;
        border-radius: 0.375rem;
        border-left: 4px solid #3b82f6;
    }

    .function-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .function-detail {
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        color: #6b7280;
    }

    .function-args {
        background-color: #1f2937;
        color: #f9fafb;
        padding: 0.5rem;
        border-radius: 0.25rem;
        font-family: monospace;
        font-size: 0.75rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .status-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 1000;
        transition: all 0.3s ease;
    }

    .status-connecting {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
    }

    .status-streaming {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #22c55e;
    }

    .status-error {
        background-color: #fee2e2;
        color: #dc2626;
        border: 1px solid #ef4444;
    }

    .clear-chat-btn {
        padding: 0.5rem 1rem;
        background-color: #ef4444;
        color: white;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-left: 0.5rem;
    }

    .clear-chat-btn:hover {
        background-color: #dc2626;
    }
</style>
{% endblock %}

{% block page_title %}æµå¼èŠå¤©åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="session-controls">
        <span class="session-id">ä¼šè¯ID: <span id="sessionId"></span></span>
        <div>
            <button class="new-session-btn" onclick="createNewSession()">æ–°ä¼šè¯</button>
            <button class="clear-chat-btn" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
        </div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
    </div>
    
    <div class="input-container">
        <textarea class="message-input" id="messageInput" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯... (Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ)"
            onkeydown="handleKeyDown(event)"></textarea>
        <button class="send-button" id="sendButton" onclick="sendMessage()">
            <span id="sendButtonText">å‘é€</span>
        </button>
    </div>
</div>

<!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
<div class="status-indicator" id="statusIndicator" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const sendButtonText = document.getElementById('sendButtonText');
    const sessionIdDisplay = document.getElementById('sessionId');
    const statusIndicator = document.getElementById('statusIndicator');

    let isStreaming = false;
    let currentStreamingMessage = null;

    // ç”Ÿæˆéšæœºä¼šè¯ID
    function generateSessionId() {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substr(2, 6);
        const userAgent = navigator.userAgent.substring(0, 3).toLowerCase();
        return `stream_${timestamp}_${randomStr}_${userAgent}`;
    }

    // åˆ›å»ºæ–°ä¼šè¯
    function createNewSession() {
        const newSessionId = generateSessionId();
        localStorage.setItem('current_stream_session_id', newSessionId);
        sessionIdDisplay.textContent = newSessionId;
        messagesContainer.innerHTML = '';
        localStorage.removeItem(`stream_chat_history_${newSessionId}`);
        showStatus('æ–°ä¼šè¯å·²åˆ›å»º', 'success');
    }

    // æ¸…ç©ºå¯¹è¯
    function clearChat() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
            messagesContainer.innerHTML = '';
            const sessionId = localStorage.getItem('current_stream_session_id');
            if (sessionId) {
                localStorage.removeItem(`stream_chat_history_${sessionId}`);
            }
            showStatus('å¯¹è¯å·²æ¸…ç©º', 'success');
        }
    }

    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(message, type = 'info', duration = 3000) {
        statusIndicator.textContent = message;
        statusIndicator.className = `status-indicator status-${type}`;
        statusIndicator.style.display = 'block';
        
        if (duration > 0) {
            setTimeout(() => {
                statusIndicator.style.display = 'none';
            }, duration);
        }
    }

    // åŠ è½½ä¼šè¯å†å²
    function loadChatHistory() {
        let sessionId = localStorage.getItem('current_stream_session_id');
        if (!sessionId) {
            sessionId = generateSessionId();
            localStorage.setItem('current_stream_session_id', sessionId);
        }
        sessionIdDisplay.textContent = sessionId;

        const history = localStorage.getItem(`stream_chat_history_${sessionId}`);
        if (history) {
            try {
                const messages = JSON.parse(history);
                messages.forEach(msg => addMessage(msg.content, msg.role, msg.toolCalls, msg.toolsUsed));
            } catch (e) {
                console.error('Failed to load chat history:', e);
            }
        }
    }

    // ä¿å­˜ä¼šè¯å†å²
    function saveChatHistory() {
        const sessionId = localStorage.getItem('current_stream_session_id');
        const messages = Array.from(messagesContainer.children).map(div => {
            const isUser = div.classList.contains('user-message');
            const content = div.querySelector('.message-content')?.textContent || div.textContent;
            const toolCalls = div.querySelector('.function-info') ? 
                Array.from(div.querySelectorAll('.function-detail')).map(el => el.textContent) : null;
            const toolsUsed = div.querySelector('.tools-info') ? 
                Array.from(div.querySelectorAll('.tool-tag')).map(el => el.textContent) : null;
            
            return {
                role: isUser ? 'user' : 'assistant',
                content: content,
                toolCalls: toolCalls,
                toolsUsed: toolsUsed
            };
        });
        localStorage.setItem(`stream_chat_history_${sessionId}`, JSON.stringify(messages));
    }

    // æ·»åŠ æ¶ˆæ¯
    function addMessage(content, role, toolCalls = null, toolsUsed = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message`;

        // åˆ›å»ºå†…å®¹å®¹å™¨
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        messageDiv.appendChild(contentDiv);

        // å¦‚æœæœ‰å·¥å…·ä½¿ç”¨ä¿¡æ¯ï¼Œæ·»åŠ å·¥å…·ä¿¡æ¯
        if (toolsUsed && toolsUsed.length > 0) {
            const toolsInfoDiv = document.createElement('div');
            toolsInfoDiv.className = 'tools-info';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'tools-info-title';
            titleDiv.textContent = 'ä½¿ç”¨çš„å·¥å…·ï¼š';
            toolsInfoDiv.appendChild(titleDiv);

            toolsUsed.forEach(tool => {
                const toolTag = document.createElement('span');
                toolTag.className = 'tool-tag';
                toolTag.textContent = tool;
                toolsInfoDiv.appendChild(toolTag);
            });

            messageDiv.appendChild(toolsInfoDiv);
        }

        // å¦‚æœæœ‰å‡½æ•°è°ƒç”¨ï¼Œæ·»åŠ å‡½æ•°è°ƒç”¨ä¿¡æ¯
        if (toolCalls && toolCalls.length > 0) {
            const functionInfoDiv = document.createElement('div');
            functionInfoDiv.className = 'function-info';

            const functionTitle = document.createElement('div');
            functionTitle.className = 'function-title';
            functionTitle.textContent = 'ğŸ”§ å·¥å…·è°ƒç”¨è¯¦æƒ…';
            functionInfoDiv.appendChild(functionTitle);

            toolCalls.forEach(call => {
                const functionDetail = document.createElement('div');
                functionDetail.className = 'function-detail';
                functionDetail.textContent = call;
                functionInfoDiv.appendChild(functionDetail);
            });

            messageDiv.appendChild(functionInfoDiv);
        }

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        saveChatHistory();
        return messageDiv;
    }

    // åˆ›å»ºæµå¼æ¶ˆæ¯
    function createStreamingMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message assistant-message streaming-message';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        messageDiv.appendChild(contentDiv);

        const indicator = document.createElement('span');
        indicator.className = 'streaming-indicator';
        contentDiv.appendChild(indicator);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        return { messageDiv, contentDiv };
    }

    // å¤„ç†æµå¼å“åº”
    async function handleStreamResponse(response) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        let buffer = '';
        let messageContent = '';
        let toolCalls = [];
        let toolsUsed = [];
        let currentToolCall = null;
        
        // åˆ›å»ºæµå¼æ¶ˆæ¯å®¹å™¨
        const { messageDiv, contentDiv } = createStreamingMessage();
        currentStreamingMessage = { messageDiv, contentDiv };

        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || ''; // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6).trim();
                        
                        if (data === '[DONE]') {
                            // æµç»“æŸ
                            contentDiv.querySelector('.streaming-indicator')?.remove();
                            messageDiv.classList.remove('streaming-message');
                            
                            // æ·»åŠ å·¥å…·ä½¿ç”¨ä¿¡æ¯
                            if (toolsUsed.length > 0) {
                                const toolsInfoDiv = document.createElement('div');
                                toolsInfoDiv.className = 'tools-info';
                                
                                const titleDiv = document.createElement('div');
                                titleDiv.className = 'tools-info-title';
                                titleDiv.textContent = 'ä½¿ç”¨çš„å·¥å…·ï¼š';
                                toolsInfoDiv.appendChild(titleDiv);

                                toolsUsed.forEach(tool => {
                                    const toolTag = document.createElement('span');
                                    toolTag.className = 'tool-tag';
                                    toolTag.textContent = `${tool.name} (${tool.key})`;
                                    toolsInfoDiv.appendChild(toolTag);
                                });

                                messageDiv.appendChild(toolsInfoDiv);
                            }

                            // æ·»åŠ å·¥å…·è°ƒç”¨ä¿¡æ¯
                            if (toolCalls.length > 0) {
                                const functionInfoDiv = document.createElement('div');
                                functionInfoDiv.className = 'function-info';

                                const functionTitle = document.createElement('div');
                                functionTitle.className = 'function-title';
                                functionTitle.textContent = 'ğŸ”§ å·¥å…·è°ƒç”¨è¯¦æƒ…';
                                functionInfoDiv.appendChild(functionTitle);

                                toolCalls.forEach(call => {
                                    const nameDetail = document.createElement('div');
                                    nameDetail.className = 'function-detail';
                                    nameDetail.textContent = `å‡½æ•°å: ${call.function.name}`;
                                    functionInfoDiv.appendChild(nameDetail);

                                    const argsDetail = document.createElement('div');
                                    argsDetail.className = 'function-detail';
                                    argsDetail.textContent = 'å‚æ•°:';
                                    functionInfoDiv.appendChild(argsDetail);

                                    const argsCode = document.createElement('div');
                                    argsCode.className = 'function-args';
                                    argsCode.textContent = call.function.arguments;
                                    functionInfoDiv.appendChild(argsCode);
                                });

                                messageDiv.appendChild(functionInfoDiv);
                            }

                            saveChatHistory();
                            return;
                        }

                        try {
                            const chunk = JSON.parse(data);
                            
                            // å¤„ç†å·¥å…·ä¿¡æ¯
                            if (chunk.type === 'tools_info' && chunk.tools_used) {
                                toolsUsed = chunk.tools_used;
                                continue;
                            }

                            // å¤„ç†èŠå¤©å®Œæˆå—
                            if (chunk.choices && chunk.choices[0]) {
                                const choice = chunk.choices[0];
                                const delta = choice.delta;

                                if (delta) {
                                    // å¤„ç†æ–‡æœ¬å†…å®¹
                                    if (delta.content) {
                                        messageContent += delta.content;
                                        contentDiv.innerHTML = messageContent + '<span class="streaming-indicator"></span>';
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    }

                                    // å¤„ç†å·¥å…·è°ƒç”¨
                                    if (delta.tool_calls) {
                                        for (const toolCallDelta of delta.tool_calls) {
                                            const index = toolCallDelta.index || 0;
                                            
                                            // ç¡®ä¿å·¥å…·è°ƒç”¨æ•°ç»„æœ‰è¶³å¤Ÿçš„å…ƒç´ 
                                            while (toolCalls.length <= index) {
                                                toolCalls.push({
                                                    id: '',
                                                    type: 'function',
                                                    function: { name: '', arguments: '' }
                                                });
                                            }

                                            if (toolCallDelta.id) {
                                                toolCalls[index].id = toolCallDelta.id;
                                            }

                                            if (toolCallDelta.function) {
                                                if (toolCallDelta.function.name) {
                                                    toolCalls[index].function.name += toolCallDelta.function.name;
                                                }
                                                if (toolCallDelta.function.arguments) {
                                                    toolCalls[index].function.arguments += toolCallDelta.function.arguments;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('Failed to parse chunk:', data, e);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Stream reading error:', error);
            contentDiv.innerHTML = messageContent + ' <span style="color: #ef4444;">[è¿æ¥ä¸­æ–­]</span>';
            throw error;
        }
    }

    // å‘é€æ¶ˆæ¯
    async function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || isStreaming) return;

        // è®¾ç½®æµå¼çŠ¶æ€
        isStreaming = true;
        messageInput.disabled = true;
        sendButton.disabled = true;
        sendButtonText.textContent = 'å‘é€ä¸­...';
        
        showStatus('æ­£åœ¨å‘é€æ¶ˆæ¯...', 'connecting', 0);

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(content, 'user');
        messageInput.value = '';

        // æ„å»ºæ¶ˆæ¯å†å²
        const messages = Array.from(messagesContainer.children)
            .filter(div => !div.classList.contains('streaming-message'))
            .map(div => ({
                role: div.classList.contains('user-message') ? 'user' : 'assistant',
                content: div.querySelector('.message-content')?.textContent || div.textContent
            }));

        try {
            const sessionId = localStorage.getItem('current_stream_session_id');
            const response = await fetch('/api/chat/completions/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Session-ID': sessionId
                },
                body: JSON.stringify({ messages })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            showStatus('æ­£åœ¨æ¥æ”¶å›å¤...', 'streaming', 0);
            await handleStreamResponse(response);
            showStatus('å›å¤å®Œæˆ', 'success');

        } catch (error) {
            console.error('Error:', error);
            showStatus(`å‘é€å¤±è´¥: ${error.message}`, 'error');
            
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æµå¼æ¶ˆæ¯
            if (currentStreamingMessage) {
                currentStreamingMessage.messageDiv.remove();
            }
            
            addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'assistant');
        } finally {
            // é‡ç½®çŠ¶æ€
            isStreaming = false;
            currentStreamingMessage = null;
            messageInput.disabled = false;
            sendButton.disabled = false;
            sendButtonText.textContent = 'å‘é€';
            messageInput.focus();
        }
    }

    // å¤„ç†é”®ç›˜äº‹ä»¶
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        loadChatHistory();
        messageInput.focus();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function () {
        if (isStreaming) {
            // å¦‚æœæ­£åœ¨æµå¼ä¼ è¾“ï¼Œä¿å­˜å½“å‰çŠ¶æ€
            saveChatHistory();
        }
    });
</script>
{% endblock %}
